generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid()) @db.Uuid
  email           String          @unique
  passwordHash    String          @map("password_hash")
  role            String          @default("user")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  workoutLogs     WorkoutLog[]
  workoutPlans    WorkoutPlan[]
  workoutSessions WorkoutSession[]

  @@map("users")
}

model WorkoutLog {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  workoutDate DateTime @map("workout_date") @db.Date
  description String
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workoutDate])
  @@index([userId, workoutDate], map: "idx_workout_logs_user_date")
  @@map("workout_logs")
}

model ExerciseCategory {
  id        Int        @id @default(autoincrement()) @db.SmallInt
  slug      String     @unique
  name      String
  exercises Exercise[]

  @@map("exercise_categories")
}

model Exercise {
  id             String               @id @default(uuid()) @db.Uuid
  categoryId     Int?                 @map("category_id") @db.SmallInt
  name           String
  equipment      String?
  isUnilateral   Boolean              @default(false) @map("is_unilateral")
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  category       ExerciseCategory?    @relation(fields: [categoryId], references: [id])
  planExercises  WorkoutPlanExercise[]
  sessionSets    WorkoutSessionSet[]

  @@unique([categoryId, name])
  @@map("exercises")
}

model WorkoutPlan {
  id            String                @id @default(uuid()) @db.Uuid
  userId        String                @map("user_id") @db.Uuid
  title         String
  description   String?
  isActive      Boolean               @default(true) @map("is_active")
  createdAt     DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  planExercises WorkoutPlanExercise[]
  sessions      WorkoutSession[]

  @@index([userId])
  @@map("workout_plans")
}

model WorkoutPlanExercise {
  id            String     @id @default(uuid()) @db.Uuid
  workoutPlanId String     @map("workout_plan_id") @db.Uuid
  exerciseId    String     @map("exercise_id") @db.Uuid
  sortOrder     Int        @map("sort_order")
  targetSets    Int?       @map("target_sets")
  targetRepsMin Int?       @map("target_reps_min")
  targetRepsMax Int?       @map("target_reps_max")
  targetWeightKg Decimal?  @map("target_weight_kg") @db.Decimal(6, 2)
  restSeconds   Int?       @map("rest_seconds")
  notes         String?
  workoutPlan   WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  exercise      Exercise    @relation(fields: [exerciseId], references: [id])

  @@unique([workoutPlanId, sortOrder])
  @@index([workoutPlanId])
  @@index([exerciseId])
  @@map("workout_plan_exercises")
}

model WorkoutSession {
  id            String              @id @default(uuid()) @db.Uuid
  userId        String              @map("user_id") @db.Uuid
  workoutPlanId String?             @map("workout_plan_id") @db.Uuid
  startedAt     DateTime            @default(now()) @map("started_at") @db.Timestamptz(6)
  finishedAt    DateTime?           @map("finished_at") @db.Timestamptz(6)
  feelingScore  Int?                @map("feeling_score") @db.SmallInt
  notes         String?
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutPlan   WorkoutPlan?        @relation(fields: [workoutPlanId], references: [id], onDelete: SetNull)
  sets          WorkoutSessionSet[]

  @@index([userId, startedAt])
  @@index([workoutPlanId])
  @@map("workout_sessions")
}

model WorkoutSessionSet {
  id               String         @id @default(uuid()) @db.Uuid
  workoutSessionId String         @map("workout_session_id") @db.Uuid
  exerciseId       String         @map("exercise_id") @db.Uuid
  setNumber        Int            @map("set_number")
  reps             Int?
  weightKg         Decimal?       @map("weight_kg") @db.Decimal(6, 2)
  rpe              Decimal?       @db.Decimal(3, 1)
  completed        Boolean        @default(true)
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  workoutSession   WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise         Exercise       @relation(fields: [exerciseId], references: [id])

  @@unique([workoutSessionId, exerciseId, setNumber])
  @@index([workoutSessionId])
  @@index([exerciseId])
  @@map("workout_session_sets")
}
